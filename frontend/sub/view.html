<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KRaft</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs" defer></script>
</head>
<body class="bg-black h-screen w-screen flex flex-col items-center justify-center m-0 p-0"
      x-data="clusterManager()">
    <div class="p-8 rounded-md shadow-lg max-w-2xl w-full mx-4 outline-white-500 h-[60vh] outline">
        <!-- bg-zinc-800 -->
        <div class="flex items-center mb-4">
            <a href="/"><h1 class="text-white font-mono text-3xl">KRaft</h1></a>
            <h3 class="text-white font-mono text-sm ml-2 self-end mb-1">by Alex</h3>
        </div>
        <div class="text-white font-mono flex flex-col mt-8">
            <a href="#" class="text-2xl underline block mt-6">> View Clusters</a>
        </div>

        <table class="table-fixed text-white font-mono mt-8">
            <thead>
                <tr>
                    <th class="px-4 py-2 border border-gray-500">Cluster</th>
                    <th class="px-4 py-2 border border-gray-500">Endpoint</th>
                    <th class="px-4 py-2 border border-gray-500">Actions</th>
                </tr>
            </thead>

            <tbody>
                <template x-for="cluster in clusters" :key="cluster.id">
                    <tr>
                        <td class="px-4 py-2 border border-gray-500" x-text="cluster.name"></td>
                        <td class="px-4 py-2 border border-gray-500" x-text="cluster.endpoint"></td>
                        <td class="px-4 py-2 border border-gray-500">
                            <button class="hover:bg-gray-500 underline">
                                View
                            </button>
                            <button class="hover:bg-gray-500 underline" @click="clusterdelete(cluster.name)">
                                Delete
                            </button>
                            <button class="hover:bg-gray-500 underline" @click="kubeconfig(cluster.name)">
                                Kubeconfig
                            </button>
                        </td>
                    </tr>
                </template>

                <!-- Show non-existent loading -->
                <tr x-show="loading">
                    <td colspan="3" class="px-4 py-2 border border-gray-500 text-center">
                        Loading clusters...
                    </td>
                </tr>

                <!-- No clusters? -->
                <tr x-show="!loading && clusters.length === 0">
                    <td colspan="3" class="px-4 py-2 border border-gray-500 text-center">
                        No clusters found
                    </td>
                </tr>
            </tbody>

        </table>

        <div class="text-2xl bg-red-300 font-mono mt-8 text-center" id="error-message">
            <!-- will be filled with error message -->
        </div>

    </div>


    <!-- 88x31 image at the bottom -->
    <div class="absolute bottom-4">
        <img src="assets/88x31.gif" alt="88x31 banner" width="88" height="31" />
    </div>

    <script>
        function clusterManager() {
            return {
                clusters: [],
                loading: true,
                error: null,

                kubeconfig(clusterName) {
                    // Create a link to trigger the download
                    const link = document.createElement('a');
                    link.href = '/api/get/kubeconfig/' + clusterName;
                    link.download = clusterName + '-kubeconfig.yaml';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                },

                // should probably have a verification :D
                clusterdelete(clustername) {
                  console.log("Delete")
                  fetch('/api/delete/cluster/' + clustername, {
                    method: 'DELETE',
                  })
                  .then(response => response.json())
                  .then(data => {
                    console.log("Data:", data);
                    if (data == "Success") {
                      location.reload();
                    }
                  })
                  .catch(error => {
                    document.getElementById('error-message').textContent = 'An error occurred, it is not your fault. Unless...';
                  });
                },

                userCheck() {
                  fetch('/auth/validate-jwt', {
                    method: 'GET',
                  })
                  .then(response => response.json())
                  .then(data => {
                    console.log("Data:", data);
                    if (data.status == "error") {
                      // redirect to login page
                      window.location.href = `/sub/login.html`;
                    } else {
                      return true;
                    }
                  })
                  .catch(error => {
                    console.log('An error occurred somewhere between here and the server.');
                  });
                },

                async getClusters() {
                    try {
                        this.loading = true;
                        const response = await fetch('/api/get/clusters');

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const data = await response.json();

                        console.log(data);

                        this.clusters = data;
                        this.error = null;
                    } catch (error) {
                        console.error('Error fetching clusters:', error);
                        this.error = error.message;
                    } finally {
                        this.loading = false;
                    }
                },

                init() {
                  this.userCheck()
                  this.getClusters();
                }
            }
        }
    </script>
</body>
